name: Render And Upload SpotDiff Video

on:
  workflow_dispatch:
    inputs:
      use_dummy_assets:
        description: "Use generated dummy assets"
        type: boolean
        required: true
        default: true
      upload_to_youtube:
        description: "Upload rendered video to YouTube"
        type: boolean
        required: true
        default: false

jobs:
  render:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-1
      S3_BUCKET: ${{ secrets.S3_BUCKET }}
      S3_PREFIX: ${{ secrets.S3_PREFIX }}
      YOUTUBE_TOKEN_JSON: ${{ secrets.YOUTUBE_TOKEN_JSON }}
      YOUTUBE_CLIENT_SECRETS_JSON: ${{ secrets.YOUTUBE_CLIENT_SECRETS_JSON }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Configure AWS credentials
        if: ${{ !inputs.use_dummy_assets }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare assets (dummy)
        if: ${{ inputs.use_dummy_assets }}
        run: |
          python scripts/generate_dummy_assets.py
          mkdir -p assets/input
          cp -r assets/dummy/* assets/input/

      - name: Prepare assets (S3)
        if: ${{ !inputs.use_dummy_assets }}
        run: |
          python scripts/download_assets.py --bucket "$S3_BUCKET" --prefix "$S3_PREFIX" --dest assets/input

      - name: Render video
        run: |
          python scripts/run_pipeline.py \
            --job config/dummy_job.json \
            --assets assets/input \
            --output out/spot_diff.mp4

      - name: Upload video to YouTube
        if: ${{ inputs.upload_to_youtube }}
        run: |
          python scripts/run_pipeline.py \
            --job config/dummy_job.json \
            --assets assets/input \
            --output out/spot_diff.mp4 \
            --upload \
            --title "脳トレ間違い探し Vol.1" \
            --description "自動生成テスト動画"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rendered-video
          path: out/spot_diff.mp4
